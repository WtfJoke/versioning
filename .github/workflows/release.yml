name: Release
on:
  issues:
    types:
      - labeled
jobs:
  create-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.label.name == 'release' }}
    steps:
      # - uses: actions/checkout@v2
      #   with:
      #     ref: develop
      - uses: actions/github-script@0.9.0
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            console.log("issue title", context.issue.title)

      - name: Setup Git
        run: |
          ls -la
          git clone "https://${GITHUB_ACTOR}-foo:${{secrets.GITHUB_TOKEN}}@github.com/${GITHUB_REPOSITORY}.git" .
          ls -la
          git config user.email "octocat@github.com"
          git config user.name ${GITHUB_ACTOR}


          git checkout develop
      - name: Create release branch
        run: |
          git checkout release
          git merge develop
      - name: Bump Version
        run: |
          yarn config set version-git-tag false
          yarn version --patch
          git commit -a -m "Bump version to ${{github.event.issue.title}}"
          git push origin release
      - uses: actions/github-script@0.9.0
        name: Create PRs
        id: create-prs
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const {owner, repo} = context.repo
            const master_pr = github.pulls.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: "Release to master",
                    head: "release",
                    base: "master",
                    });
            const develop_pr = github.pulls.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: "Release to develop",
                    head: "release",
                    base: "develop",
                    });
            const [master_pr_result, develop_pr_result] = await Promise.all([master_pr, develop_pr])
            console.log(`::set-output name=master_pr::${master_pr_result.data.number}`)
            console.log(`::set-output name=develop_pr::${develop_pr_result.data.number}`)
      - uses: actions/github-script@0.9.0
        name: Approve PRs
        env:
          MASTER_PR: ${{ steps.create-prs.outputs.master_pr }}
          DEVELOP_PR: ${{ steps.create-prs.outputs.develop_pr }}
        with:
          github-token: ${{secrets.GH_TOKEN}}
          script: |
            const {owner, repo} = context.repo

            const master_review = github.pulls.createReview({
                owner,
                repo,
                pull_number: process.env.MASTER_PR,
                event: "APPROVE",
                "comments": []
                })
            const developer_review = github.pulls.createReview({
                owner,
                repo,
                pull_number: process.env.DEVELOP_PR,
                event: "APPROVE",
                "comments": []
                })
            await Promise.all([master_review, developer_review])

            const master_merge = await github.pulls.merge({
                owner,
                repo,
                pull_number: process.env.MASTER_PR,
                merge_method: "rebase"
                })

            const develop_merge = await github.pulls.merge({
                owner,
                repo,
                pull_number: process.env.DEVELOP_PR,
                merge_method: "rebase"
                })

      - name: PR Branches
        run: |
          hub pull-request -m "Release ${{github.event.issue.title}} to master" -b master
          hub pull-request -m "Release ${{github.event.issue.title}} to develop" -b develop
    #   # - name: Merge to master
    #   run: |
    #     cat .git/config
    #     git fetch origin
    #     git checkout master
    #     git merge --no-ff -m "Merge ${{github.event.issue.title}} into master" release
    #     git tag -a -m "add tag to master with ${{github.event.issue.title}}" "${{github.event.issue.title}}"
    # - name: Merge to develop
    #   run: |
    #     git checkout develop
    #     git merge --no-ff release
    # - name: Delete release Branch
    #   run: |
    #     git branch -d release
    # - name: Push new Branches
    #   run: |
    #     hub pull-request -m "Release ${{github.event.issue.title}} to master" -
    #     git push origin master
    #     git push origin develop
    #     git push --tags
    # const develop_pr = github.pulls.create({
    #         owner,
    #         repo,
    #         title: "Release ${{github.event.issue.title}} to develop",
    #         head: "release",
    #         base: "develop",
    #         });
    # const [master_pr_result, develop_pr_result] = await Promise.all([promise1, promise2, promise3])
    # console.log(develop_pr_result.id, develop_pr_result.name)
    # console.log(master_pr_result.id, master_pr_result.name)
